<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸææ–™è¯†åˆ« - å¡è·¯é‡ŒåŸºç«™</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .header {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #2e8b57;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
        }
        
        .nav-links li {
            margin-left: 20px;
        }
        
        .nav-links li a {
            text-decoration: none;
            color: #333;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .nav-links li a:hover,
        .nav-links li a.active {
            color: #2e8b57;
            background-color: rgba(46, 139, 87, 0.1);
        }
        
        /* åŒºå—æ ·å¼ */
        .section {
            padding: 80px 0;
        }
        
        .section-title {
            font-size: 36px;
            color: #2e8b57;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .section-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
            text-align: center;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            padding-top: 120px;
            min-height: 100vh;
        }
        
        /* è¯†åˆ«ç»“æœæ“ä½œæŒ‰é’®æ ·å¼ */
        .recognition-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .btn-primary {
            display: inline-block;
            padding: 12px 30px;
            background-color: #2196f3;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #1976d2;
        }
        
        .btn-secondary {
            display: inline-block;
            padding: 12px 30px;
            background-color: #e0e0e0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: #d5d5d5;
        }
        
        .btn-primary,
        .btn-secondary {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            text-decoration: none;
            text-align: center;
            flex: 1;
        }
        
        .btn-primary {
            background-color: #22c55e;
            color: #fff;
            border: none;
        }
        
        .btn-secondary {
            background-color: #ffffff;
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        /* è¯†åˆ«åŒºåŸŸ */
        .recognition-container {
            display: flex;
            gap: 30px;
            margin-bottom: 50px;
        }
        
        /* å›¾ç‰‡åŒºåŸŸ */
        .image-section {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .image-placeholder {
            width: 100%;
            aspect-ratio: 4/3;
            border: 2px dashed #2e8b57;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        
        .image-placeholder-text {
            color: #2e8b57;
            font-size: 18px;
            text-align: center;
            padding: 20px;
        }
        
        .upload-btn {
            background-color: #2e8b57;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background-color: #246e47;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
        
        /* ç»“æœåŒºåŸŸ */
        .result-section {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        
        .result-header {
            font-size: 22px;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8f5e8;
        }
        
        .dish-name {
            font-size: 24px;
            color: #2e8b57;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .nutrition-info {
            margin-bottom: 25px;
        }
        
        .nutrition-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .nutrition-row:last-child {
            border-bottom: none;
        }
        
        .nutrition-label {
            color: #666;
        }
        
        .nutrition-value {
            font-weight: bold;
            color: #333;
        }
        
        .nutrition-list {
            margin-top: 15px;
        }
        
        .nutrition-list h4 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .nutrition-list ul {
            list-style: none;
            padding-left: 0;
        }
        
        .nutrition-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .nutrition-list li::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #2e8b57;
            font-size: 18px;
        }
        
        .nutrition-note {
            background-color: #f8f9fa;
            border-left: 3px solid #2e8b57;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-style: italic;
            color: #666;
        }
        
        .add-tracking-btn {
            background-color: #2e8b57;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .add-tracking-btn:hover {
            background-color: #246e47;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
        
        /* æç¤ºæ ·å¼ */
        .tip-box {
            background-color: #e8f5e8;
            border-left: 4px solid #2e8b57;
            padding: 20px;
            margin-top: 50px;
            border-radius: 5px;
            text-align: center;
            color: #555;
        }
        
        /* è¿”å›é¦–é¡µæŒ‰é’® */
        .back-home {
            text-align: center;
            margin-top: 50px;
        }
        
        .btn-secondary {
            display: inline-block;
            background-color: white;
            color: #2e8b57;
            border: 1px solid #2e8b57;
            padding: 10px 25px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background-color: #2e8b57;
            color: white;
        }
        
        /* é¡µè„šæ ·å¼ */
        .footer {
            background-color: #2e8b57;
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-top: 100px;
        }
        
        .footer p {
            margin-bottom: 10px;
        }
        
        .footer p:last-child {
            margin-bottom: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 992px) {
            .navbar {
                flex-direction: column;
            }
            
            .logo {
                margin-bottom: 15px;
            }
            
            .recognition-container {
                flex-direction: column;
            }
            
            .image-section,
            .result-section {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-links li {
                margin: 5px;
            }
            
            .section-title {
                font-size: 28px;
            }
            
            .image-section,
            .result-section {
                padding: 20px;
            }
            
            .dish-name {
                font-size: 24px;
            }
            
            .nutrition-row {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 576px) {
            .image-placeholder-text {
                font-size: 16px;
            }
            
            .upload-btn,
            .add-tracking-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* ç³»ç»Ÿè®¾ç½®å¡ç‰‡æ ·å¼ - ç»¿è‰²ä¸»é¢˜ */
        .settings-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .settings-title {
            font-size: 18px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-item {
            margin-bottom: 12px;
        }
        
        .setting-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .setting-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: #f9f9f9;
        }
        
        /* æ»‘å—æ ·å¼ - ç»¿è‰²ä¸»é¢˜ */
        .setting-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #c8e6c9;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin: 8px 0;
        }
        
        .setting-slider:hover {
            opacity: 1;
        }
        
        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
        }
        
        .setting-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
        }
        
        .slider-value {
            font-size: 12px;
            color: #666;
            display: inline-block;
            margin-left: 10px;
        }
        
        .setting-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* æŒ‰é’®æ ·å¼ - ç»¿è‰²ä¸»é¢˜ */
        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 4px;
        }
        
        .control-btn-primary {
            background-color: #4caf50;
            color: white;
        }
        
        .control-btn-primary:hover {
            background-color: #388e3c;
        }
        
        .control-btn-secondary {
            background-color: #66bb6a;
            color: white;
        }
        
        .control-btn-secondary:hover {
            background-color: #43a047;
        }
        
        .control-btn-danger {
            background-color: #ef5350;
            color: white;
        }
        
        .control-btn-danger:hover {
            background-color: #c62828;
        }
        
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2e8b57;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* çŠ¶æ€æ ‡ç­¾ - ç»¿è‰²ä¸»é¢˜ */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
        
        .status-badge.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .status-badge.warning {
            background-color: #fff8e1;
            color: #ff8f00;
            border: 1px solid #ffb74d;
        }
        
        .status-badge.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }
        
        /* æŒ‰é’®åŒºåŸŸæ ·å¼ */
        .buttons-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 60px;
            flex-wrap: wrap;
        }
        
        /* åº•éƒ¨è¯´æ˜æ–‡å­— */
        .bottom-note {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* ä»ªè¡¨ç›˜å¸ƒå±€æ ·å¼ */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .main-area {
            display: flex;
            flex-direction: column;
        }
        
        .camera-frame {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        /* æŒ‡æ ‡å¡ç‰‡æ ·å¼ */
        .metric-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid #2e8b57;
        }
        
        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .metric-category {
            font-size: 14px;
            color: #2e8b57;
            font-weight: 500;
        }
        
        .weight-text {
            font-size: 36px;
            font-weight: bold;
            color: #2e8b57;
            margin-bottom: 5px;
        }
        
        .metric-unit {
            font-size: 16px;
            color: #666;
        }
        
        .metric-actions {
            margin-top: 15px;
        }
        
        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 992px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">å¡è·¯é‡ŒåŸºç«™ Calorie Station</a>
                <ul class="nav-links">
                    <li><a href="index.html">é¦–é¡µ</a></li>
                    <li><a href="cooking-assistant.html">çƒ¹é¥ªåŠ©æ‰‹</a></li>
                    <li><a href="recipe-recommend.html">èœè°±æ¨è</a></li>
                    <li><a href="health-tracking.html">å¥åº·è¿½è¸ª</a></li>
                    <li><a href="dish-recognition.html" class="active">åŸææ–™è¯†åˆ«</a></li>
                    <li><a href="nutrition-knowledge.html">è¥å…»ç§‘æ™®</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="container">
            <h1 class="section-title">åŸææ–™è¯†åˆ«</h1>
            <p class="section-subtitle">AI è¯†åˆ«è”¬èœã€è‚‰ç±»ç­‰åŸææ–™ï¼Œå¹¶ç»™å‡ºçƒ¹é¥ªæ¨è</p>
            
            <div class="dashboard-layout">
                <!-- å·¦ä¾§ç³»ç»Ÿè®¾ç½®åŒºåŸŸ -->
                <div class="sidebar">
                    <!-- ç³»ç»Ÿè®¾ç½®å¡ç‰‡ -->
                    <div class="settings-card">
                        <div class="settings-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
                        
                        <!-- ä¸²å£è¿æ¥è®¾ç½® -->
                        <div class="setting-group">
                            <div class="settings-title" style="font-size: 16px;">ä¸²å£è¿æ¥</div>
                            <div class="setting-item">
                                <label class="setting-label">ç«¯å£é€‰æ‹©</label>
                                <select id="port-select" class="setting-select">
                                    <option value="">é€‰æ‹©ç«¯å£...</option>
                                    <option value="COM1">COM1</option>
                                    <option value="COM2">COM2</option>
                                    <option value="COM3">COM3</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">æ³¢ç‰¹ç‡</label>
                                <select id="baudrate-select" class="setting-select">
                                    <option value="9600">9600</option>
                                    <option value="115200">115200</option>
                                </select>
                            </div>
                            <div class="setting-buttons">
                                <button id="connect-btn" class="control-btn control-btn-primary">è¿æ¥</button>
                                <button id="disconnect-btn" class="control-btn control-btn-secondary" disabled>æ–­å¼€</button>
                            </div>
                            <div class="setting-item" style="margin-top: 10px;">
                                <span id="connection-status" class="status-badge warning">æœªè¿æ¥</span>
                            </div>
                        </div>
                        
                        <!-- è¯†åˆ«æ§åˆ¶è®¾ç½® -->
                        <div class="setting-group">
                            <div class="settings-title" style="font-size: 16px;">è¯†åˆ«æ§åˆ¶</div>
                            <div class="setting-item">
                                <label class="setting-label">æ‘„åƒå¤´ç´¢å¼•</label>
                                <select id="camera-select" class="setting-select">
                                    <option value="0">é»˜è®¤æ‘„åƒå¤´ (0)</option>
                                    <option value="1">æ‘„åƒå¤´ 1</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">è¯†åˆ«çµæ•åº¦</label>
                                <input type="range" id="confidence-slider" min="0.1" max="1.0" step="0.05" value="0.25" class="setting-slider">
                                <span class="slider-value" id="confidence-value">0.25</span>
                            </div>
                            <div class="setting-buttons">
                                <button id="reset-btn" class="control-btn control-btn-secondary">é‡ç½®/é‡æ–°è¯†åˆ«</button>
                            </div>
                            <div class="setting-item">
                                <label class="setting-label">ğŸš€ å¯åŠ¨ç³»ç»Ÿ</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="system-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ä¸»å†…å®¹åŒºåŸŸ -->
                <div class="main-area">
                    <!-- æ‘„åƒå¤´ç”»é¢åŒºåŸŸ -->
                    <div class="camera-frame">
                        <div id="camera-preview" style="border: 2px dashed #2e8b57; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 20px; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                            <p style="font-size: 16px; color: #666;">æ‘„åƒå¤´å®æ—¶ç”»é¢å ä½</p>
                        </div>
                    </div>
                    
                    <!-- ç»“æœå¡ç‰‡åŒºåŸŸ -->
                    <div class="results-grid">
                        <!-- è¯†åˆ«ç»“æœå¡ç‰‡ -->
                        <div class="metric-card">
                            <div class="metric-title">è¯†åˆ«ç»“æœ</div>
                            <div class="metric-value" id="material-name">ç­‰å¾…è¯†åˆ«â€¦</div>
                            <div class="metric-category" id="material-category">--</div>
                        </div>
                        
                        <!-- ç§°é‡ç»“æœå¡ç‰‡ -->
                        <div class="metric-card">
                            <div class="metric-title">å®æ—¶é‡é‡</div>
                            <div class="weight-text" id="material-weight">--</div>
                            <div class="metric-unit">g</div>
                        </div>
                        
                        <!-- çŠ¶æ€å¡ç‰‡ -->
                        <div class="metric-card">
                            <div class="metric-title">çŠ¶æ€</div>
                            <div class="metric-value" id="system-status">ç­‰å¾…æ”¾ç½®ç‰©å“</div>
                            <div class="metric-actions">
                                <button id="view-detail-btn" class="control-btn control-btn-primary" style="margin-top: 10px; width: 100%;">æŸ¥çœ‹è¯¦ç»†è¥å…»ä¿¡æ¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- çƒ¹é¥ªå°åŠ©æ‰‹åŒºåŸŸå·²ç§»é™¤ -->
            
            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="buttons-section">
                <a href="index.html" class="btn-secondary">è¿”å›é¦–é¡µ</a>
                <a href="cooking-assistant.html" class="btn-secondary">å»çƒ¹é¥ªåŠ©æ‰‹æŸ¥çœ‹æ›´å¤šåšæ³•</a>
            </div>
            
            <!-- åº•éƒ¨è¯´æ˜æ–‡å­— -->
            <div class="bottom-note">
                æœ¬é¡µé¢ä¸ºåŸææ–™è¯†åˆ«ä¸çƒ¹é¥ªå»ºè®®ç•Œé¢ç¤ºæ„ï¼Œæ‰€æœ‰æ•°æ®ä¸èœå“ä»…ä¸ºç¤ºä¾‹å±•ç¤ºï¼Œä¸ä½œä¸ºçœŸå®è¥å…»å»ºè®®æˆ–åŒ»ç–—è¯Šæ–­ä¾æ®ã€‚
            </div>
        </div>
    </main>
    
    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <p>Â© 2025 å¡è·¯é‡ŒåŸºç«™ | AI æ™ºèƒ½é¥®é£Ÿä¸è¥å…»ç®¡ç†å¹³å°</p>

        </div>
    </footer>
    <script>
        // ç³»ç»ŸçŠ¶æ€å˜é‡
        let systemState = {
            connected: false,
            running: false,
            detectionLocked: false,
            frozenFrame: null,
            frozenProductName: null,
            currentName: null,
            currentWeight: null,
            currentCategory: null,
            currentCalories: null,
            port: null,
            baudrate: null,
            cameraIndex: 0,
            confidenceThreshold: 0.25
        };

        // é¢„å®šä¹‰é£Ÿææ˜ å°„ï¼ˆä¸åç«¯ FOOD_META ä¿æŒä¸€è‡´ï¼‰
        const FOOD_META = {
          "bell pepper": { nameZh: "è¾£æ¤’", category: "è”¬èœç±»", caloriesPer100g: 31 },
          "bell peppers": { nameZh: "è¾£æ¤’", category: "è”¬èœç±»", caloriesPer100g: 31 },
          "capsicum": { nameZh: "è¾£æ¤’", category: "è”¬èœç±»", caloriesPer100g: 31 },
          "mush": { nameZh: "è˜‘è‡", category: "èŒè‡ç±»", caloriesPer100g: 22 },
          "mushroom": { nameZh: "è˜‘è‡", category: "èŒè‡ç±»", caloriesPer100g: 22 },
          "mushrooms": { nameZh: "è˜‘è‡", category: "èŒè‡ç±»", caloriesPer100g: 22 },
          "banana": { nameZh: "é¦™è•‰", category: "æ°´æœç±»", caloriesPer100g: 89 },
          "bananas": { nameZh: "é¦™è•‰", category: "æ°´æœç±»", caloriesPer100g: 89 },
          "tomato": { nameZh: "è¥¿çº¢æŸ¿", category: "è”¬èœæ°´æœç±»", caloriesPer100g: 19 },
          "tomatoes": { nameZh: "è¥¿çº¢æŸ¿", category: "è”¬èœæ°´æœç±»", caloriesPer100g: 19 },
          "apple": { nameZh: "è‹¹æœ", category: "æ°´æœç±»", caloriesPer100g: 52 },
          "apples": { nameZh: "è‹¹æœ", category: "æ°´æœç±»", caloriesPer100g: 52 },
          "carrot": { nameZh: "èƒ¡èåœ", category: "è”¬èœç±»", caloriesPer100g: 41 },
          "carrots": { nameZh: "èƒ¡èåœ", category: "è”¬èœç±»", caloriesPer100g: 41 },
          "onion": { nameZh: "æ´‹è‘±", category: "è”¬èœç±»", caloriesPer100g: 40 },
          "onions": { nameZh: "æ´‹è‘±", category: "è”¬èœç±»", caloriesPer100g: 40 },
          "cucumber": { nameZh: "é»„ç“œ", category: "è”¬èœç±»", caloriesPer100g: 16 },
          "cucumbers": { nameZh: "é»„ç“œ", category: "è”¬èœç±»", caloriesPer100g: 16 },
          "potato": { nameZh: "åœŸè±†", category: "è”¬èœç±»", caloriesPer100g: 77 },
          "potatoes": { nameZh: "åœŸè±†", category: "è”¬èœç±»", caloriesPer100g: 77 },
          "orange": { nameZh: "æ©™å­", category: "æ°´æœç±»", caloriesPer100g: 47 },
          "oranges": { nameZh: "æ©™å­", category: "æ°´æœç±»", caloriesPer100g: 47 }
        };

        // è·å–DOMå…ƒç´ 
        const portSelect = document.getElementById("port-select");
        const baudrateSelect = document.getElementById("baudrate-select");
        const connectBtn = document.getElementById("connect-btn");
        const disconnectBtn = document.getElementById("disconnect-btn");
        const connectionStatus = document.getElementById("connection-status");
        const cameraSelect = document.getElementById("camera-select");
        const confidenceSlider = document.getElementById("confidence-slider");
        const confidenceValue = document.getElementById("confidence-value");
        const resetBtn = document.getElementById("reset-btn");
        const systemToggle = document.getElementById("system-toggle");
        const materialName = document.getElementById("material-name");
        const materialCategory = document.getElementById("material-category");
        const materialWeight = document.getElementById("material-weight");
        const systemStatus = document.getElementById("system-status");
        const viewDetailBtn = document.getElementById("view-detail-btn");
        const cameraPreview = document.getElementById("camera-preview");

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
        function updateSystemStatus() {
            if (systemState.detectionLocked) {
                systemStatus.textContent = "ğŸ”’ å·²é”å®šç»“æœï¼Œç‚¹å‡»é‡ç½®é‡æ–°è¯†åˆ«";
                systemStatus.style.color = "#2e8b57";
            } else if (systemState.running) {
                systemStatus.textContent = "ğŸ‘€ æ­£åœ¨è¯†åˆ«...";
                systemStatus.style.color = "#ff9800";
            } else {
                systemStatus.textContent = "ç­‰å¾…æ”¾ç½®ç‰©å“";
                systemStatus.style.color = "#666";
            }
        }

        // æ¨¡æ‹Ÿä¸²å£è¿æ¥
        function connectSerial() {
            const port = portSelect.value;
            const baudrate = baudrateSelect.value;
            
            if (!port || !baudrate) {
                alert("è¯·é€‰æ‹©ç«¯å£å’Œæ³¢ç‰¹ç‡");
                return;
            }
            
            // æ¨¡æ‹Ÿè¿æ¥è¿‡ç¨‹
            systemState.port = port;
            systemState.baudrate = baudrate;
            systemState.connected = true;
            
            // æ›´æ–°UI
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            portSelect.disabled = true;
            baudrateSelect.disabled = true;
            connectionStatus.textContent = "å·²è¿æ¥";
            connectionStatus.className = "status-badge success";
            
            alert(`ä¸²å£å·²è¿æ¥: ${port} @ ${baudrate}`);
        }

        // æ¨¡æ‹Ÿæ–­å¼€ä¸²å£
        function disconnectSerial() {
            systemState.connected = false;
            systemState.port = null;
            systemState.baudrate = null;
            
            // æ›´æ–°UI
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            portSelect.disabled = false;
            baudrateSelect.disabled = false;
            connectionStatus.textContent = "æœªè¿æ¥";
            connectionStatus.className = "status-badge warning";
            
            // å¦‚æœç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œåœæ­¢ç³»ç»Ÿ
            if (systemState.running) {
                systemToggle.checked = false;
                stopSystem();
            }
        }

        // å¯åŠ¨ç³»ç»Ÿ
        function startSystem() {
            if (!systemState.connected) {
                alert("è¯·å…ˆè¿æ¥ä¸²å£");
                systemToggle.checked = false;
                return;
            }
            
            systemState.running = true;
            systemState.detectionLocked = false;
            
            // æ›´æ–°æ‘„åƒå¤´é¢„è§ˆ
            cameraPreview.innerHTML = '<p style="font-size: 16px; color: #2e8b57;">ğŸ“¹ æ‘„åƒå¤´æ­£åœ¨è¿è¡Œ...</p>';
            
            // æ›´æ–°çŠ¶æ€
            updateSystemStatus();
            
            // å¼€å§‹æ¨¡æ‹Ÿè¯†åˆ«è¿‡ç¨‹
            simulateRecognition();
        }

        // åœæ­¢ç³»ç»Ÿ
        function stopSystem() {
            systemState.running = false;
            systemState.detectionLocked = false;
            
            // é‡ç½®æ˜¾ç¤º
            cameraPreview.innerHTML = '<p style="font-size: 16px; color: #666;">æ‘„åƒå¤´å®æ—¶ç”»é¢å ä½</p>';
            materialName.textContent = "ç­‰å¾…è¯†åˆ«...";
            materialCategory.textContent = "--";
            materialWeight.textContent = "--";
            systemState.currentName = null;
            
            // æ›´æ–°çŠ¶æ€
            updateSystemStatus();
        }

        // é‡ç½®è¯†åˆ«
        function resetRecognition() {
            if (!systemState.running) {
                alert("è¯·å…ˆå¯åŠ¨ç³»ç»Ÿ");
                return;
            }
            
            systemState.detectionLocked = false;
            materialName.textContent = "ç­‰å¾…è¯†åˆ«...";
            materialCategory.textContent = "--";
            materialWeight.textContent = "--";
            systemState.currentName = null;
            
            // æ›´æ–°çŠ¶æ€
            updateSystemStatus();
            
            // é‡æ–°å¼€å§‹è¯†åˆ«
            simulateRecognition();
        }

        // æ¨¡æ‹Ÿè¯†åˆ«è¿‡ç¨‹
        async function simulateRecognition() {
            if (!systemState.running || systemState.detectionLocked) return;
            
            try {
                // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // è°ƒç”¨åç«¯API
                const res = await fetch("http://127.0.0.1:9000/scan-material", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        camera_index: parseInt(cameraSelect.value),
                        frames: 5,
                        conf_threshold: parseFloat(confidenceSlider.value)
                    })
                });
                
                if (!res.ok) throw new Error("HTTP " + res.status);
                const data = await res.json();
                
                // å¦‚æœAPIè°ƒç”¨æˆåŠŸï¼Œé”å®šç»“æœ
                lockRecognitionResult(data);
            } catch (err) {
                console.log("APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:", err.message);
                
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤º
                const mockFoods = ["banana", "tomato", "bell pepper", "mushroom", "apple"];
                const randomFood = mockFoods[Math.floor(Math.random() * mockFoods.length)];
                const mockData = {
                    rawLabel: randomFood,
                    nameZh: FOOD_META[randomFood].nameZh,
                    category: FOOD_META[randomFood].category,
                    weight: Math.floor(Math.random() * 200) + 50, // 50-250g
                    caloriesPer100g: FOOD_META[randomFood].caloriesPer100g,
                    confidence: Math.random() * 0.3 + 0.7 // 0.7-1.0
                };
                
                lockRecognitionResult(mockData);
            }
        }

        // é”å®šè¯†åˆ«ç»“æœ
        function lockRecognitionResult(data) {
            // æŸ¥æ‰¾é£Ÿæå…ƒæ•°æ®
            const meta = FOOD_META[data.rawLabel] || null;
            
            // è®¾ç½®æ˜¾ç¤ºæ•°æ®
            const displayName = data.nameZh || (meta && meta.nameZh) || data.rawLabel || "æœªçŸ¥";
            const displayCategory = data.category || (meta && meta.category) || "å…¶ä»–";
            const displayWeight = typeof data.weight === "number" ? data.weight.toFixed(1) : "--";
            
            // æ›´æ–°DOM
            materialName.textContent = displayName;
            materialCategory.textContent = displayCategory;
            materialWeight.textContent = displayWeight;
            
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            systemState.detectionLocked = true;
            systemState.currentName = displayName;
            systemState.currentWeight = displayWeight;
            systemState.currentCategory = displayCategory;
            
            // æ›´æ–°UI
            updateSystemStatus();
            
            // æ›´æ–°æ‘„åƒå¤´é¢„è§ˆæ˜¾ç¤ºè¯†åˆ«ç»“æœ
            cameraPreview.innerHTML = `
                <div style="text-align: center;">
                    <p style="font-size: 16px; color: #2e8b57; margin-bottom: 10px;">ğŸ”’ å·²é”å®šè¯†åˆ«ç»“æœ</p>
                    <p style="font-size: 18px; font-weight: bold; color: #333;">${displayName}</p>
                </div>
            `;
        }

        // â€œæŸ¥çœ‹è¯¦ç»†è¥å…»ä¿¡æ¯â€æŒ‰é’®å¤„ç†
        function handleViewDetail() {
            const foodName = systemState.currentName || materialName.textContent.trim();
            
            if (!foodName || foodName === "ç­‰å¾…è¯†åˆ«â€¦" || foodName === "è¯†åˆ«å¤±è´¥") {
                alert("è¯·å…ˆå®Œæˆä¸€æ¬¡æœ‰æ•ˆè¯†åˆ«");
                return;
            }
            
            const url = "food-detail.html?food=" + encodeURIComponent(foodName);
            window.location.href = url;
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEvents() {
            // ä¸²å£è¿æ¥æŒ‰é’®
            if (connectBtn) connectBtn.addEventListener("click", connectSerial);
            if (disconnectBtn) disconnectBtn.addEventListener("click", disconnectSerial);
            
            // ä¿¡å¿ƒåº¦æ»‘å—
            if (confidenceSlider) {
                confidenceSlider.addEventListener("input", () => {
                    if (confidenceValue) confidenceValue.textContent = confidenceSlider.value;
                    systemState.confidenceThreshold = parseFloat(confidenceSlider.value);
                });
            }
            
            // é‡ç½®æŒ‰é’®
            if (resetBtn) resetBtn.addEventListener("click", resetRecognition);
            
            // ç³»ç»Ÿå¼€å…³
            if (systemToggle) {
                systemToggle.addEventListener("change", (e) => {
                    if (e.target.checked) {
                        startSystem();
                    } else {
                        stopSystem();
                    }
                });
            }
            
            // æ‘„åƒå¤´é€‰æ‹©
            if (cameraSelect) {
                cameraSelect.addEventListener("change", () => {
                    systemState.cameraIndex = parseInt(cameraSelect.value);
                });
            }
            
            // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
            if (viewDetailBtn) viewDetailBtn.addEventListener("click", handleViewDetail);
        }

        // åˆå§‹åŒ–
        function init() {
            bindEvents();
            updateSystemStatus();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener("DOMContentLoaded", init);
    </script>
    </body>
</html>